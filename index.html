<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRADE ARMY | V.1 - NOTIFICATION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { background: #0c0d10; margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; color: #d1d4dc; font-family: 'Inter', sans-serif; }
        #chart-grid { display: grid; height: 100%; width: 100%; gap: 1px; background: #1e222d; }
        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .control-btn { background: #1e222d; color: #81858e; border: 1px solid #2a2e39; padding: 5px 12px; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .active-layout { background: #2962ff !important; color: white !important; }
        .notify-btn { background: #ff9800 !important; color: black !important; border: none; font-size: 10px; }
    </style>
</head>
<body class="flex flex-col">

    <header class="h-16 border-b border-[#1e222d] bg-[#131722] flex items-center justify-between px-4 shrink-0 z-50">
        <div class="flex items-center space-x-4">
            <div class="flex flex-col">
                <span class="text-white font-black italic text-lg tracking-tighter">TRADE ARMY</span>
                <span class="text-blue-500 text-[10px] font-bold tracking-[3px]">SMART NOTIFY V.1</span>
            </div>
            <button onclick="requestNotifyPermission()" id="permBtn" class="control-btn notify-btn">ðŸ”” BÄ°LDÄ°RÄ°MLERÄ° AÃ‡</button>
        </div>

        <div class="flex items-center space-x-2 bg-black/40 p-2 rounded-lg border border-gray-800">
            <input type="text" id="alarmSymbol" placeholder="BTCUSDT" class="bg-transparent text-xs w-20 outline-none text-blue-500 font-bold uppercase">
            <input type="number" id="alarmPrice" placeholder="Fiyat" class="bg-transparent text-xs w-20 outline-none text-white font-bold">
            <button onclick="addAlarm()" class="bg-blue-600 px-3 py-1 rounded text-[10px] font-bold text-white uppercase">Alarm Ekle</button>
        </div>

        <div id="clock" class="text-white font-mono text-sm font-bold">00:00:00</div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="w-14 border-r border-[#1e222d] bg-[#0c0d10] flex flex-col items-center py-4 space-y-4 shrink-0">
            <button onclick="updateSymbol('BINANCE:BTCUSDT')" class="text-xl">â‚¿</button>
            <button onclick="updateSymbol('NASDAQ:IXIC')" class="text-xl">ðŸ“ˆ</button>
        </aside>

        <main class="flex-1 bg-black">
            <div id="chart-grid" class="grid-1">
                <div id="tv_1" class="w-full h-full"></div>
                <div id="tv_2" class="w-full h-full hidden"></div>
                <div id="tv_3" class="w-full h-full hidden"></div>
                <div id="tv_4" class="w-full h-full hidden"></div>
            </div>
        </main>

        <aside class="w-[280px] bg-[#131722] border-left border-[#1e222d] p-3 overflow-y-auto">
            <div class="text-[10px] font-bold text-gray-500 mb-4 uppercase tracking-widest">Alarm Takip Listesi</div>
            <div id="alarm-list-container" class="space-y-2"></div>
        </aside>
    </div>

    <audio id="alarmSound"><source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        let alarmlar = JSON.parse(localStorage.getItem('trade_army_alarms')) || [];
        let currentSymbol = 'BINANCE:BTCUSDT';

        // BÄ°LDÄ°RÄ°M Ä°ZNÄ°
        function requestNotifyPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    document.getElementById('permBtn').style.display = 'none';
                    new Notification("TRADE ARMY", { body: "Bildirimler aktif edildi!", icon: "https://via.placeholder.com/100" });
                }
            });
        }

        // BÄ°NANCE CANLI VERÄ° BAÄžLANTISI
        const ws = new WebSocket('wss://stream.binance.com:9443/ws/!ticker@arr');
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            alarmlar.forEach((alarm) => {
                if (!alarm.active) return;
                const parite = data.find(p => p.s === alarm.symbol);
                if (parite) {
                    const anlikFiyat = parseFloat(parite.c);
                    // Alarm kontrolÃ¼
                    if ((alarm.dir === 'up' && anlikFiyat >= alarm.price) || (alarm.dir === 'down' && anlikFiyat <= alarm.price)) {
                        triggerAlarm(alarm);
                    }
                }
            });
        };

        function addAlarm() {
            const sym = document.getElementById('alarmSymbol').value.toUpperCase();
            const prc = parseFloat(document.getElementById('alarmPrice').value);
            if(!sym || !prc) return;

            // Åžimdiki fiyata gÃ¶re yÃ¶n tayini
            const dir = 'up'; // GeliÅŸtirilebilir: Mevcut fiyat Ã§ekilip otomatik atanabilir
            alarmlar.push({ id: Date.now(), symbol: sym, price: prc, active: true, dir: dir });
            localStorage.setItem('trade_army_alarms', JSON.stringify(alarmlar));
            renderAlarms();
        }

        function triggerAlarm(alarm) {
            alarm.active = false;
            localStorage.setItem('trade_army_alarms', JSON.stringify(alarmlar));
            renderAlarms();
            
            // 1. Ses Ã‡al
            document.getElementById('alarmSound').play();
            
            // 2. TarayÄ±cÄ± Bildirimi GÃ¶nder
            if (Notification.permission === "granted") {
                new Notification("ðŸš¨ HEDEF FÄ°YAT AÅžILDI!", {
                    body: `${alarm.symbol} fiyatÄ± ${alarm.price} seviyesine ulaÅŸtÄ±.`,
                    icon: "https://via.placeholder.com/100"
                });
            }
        }

        function renderAlarms() {
            const container = document.getElementById('alarm-list-container');
            container.innerHTML = alarmlar.map(a => `
                <div class="bg-black/40 p-2 rounded border border-gray-800 flex justify-between items-center ${a.active ? '' : 'opacity-20'}">
                    <span class="text-xs font-mono">${a.symbol} @ ${a.price}</span>
                    <button onclick="removeAlarm(${a.id})" class="text-red-500 text-[10px]">SÄ°L</button>
                </div>
            `).join('');
        }

        function removeAlarm(id) {
            alarmlar = alarmlar.filter(a => a.id !== id);
            localStorage.setItem('trade_army_alarms', JSON.stringify(alarmlar));
            renderAlarms();
        }

        function initChart(id, symbol) {
            new TradingView.widget({ "autosize": true, "symbol": symbol, "interval": "60", "theme": "dark", "container_id": id });
        }

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
        window.onload = () => { renderAlarms(); initChart('tv_1', currentSymbol); if(Notification.permission === "granted") document.getElementById('permBtn').style.display='none'; };
    </script>
</body>
</html>
